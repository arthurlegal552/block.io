<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Parkour em Three.js</title>
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.150.1/examples/jsm/"
  }
}
</script>
</head>
<body style="margin:0; overflow:hidden;">
<script type="module">
import * as THREE from 'three';
import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

// ——————————————————————
// 1️⃣ Cena, Câmera e Renderer
// ——————————————————————
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000 );
camera.position.set(0, 1.6, 0);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

// ——————————————————————
// 2️⃣ Iluminação
// ——————————————————————
scene.add(new THREE.AmbientLight(0xffffff, 1.2));
const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
dirLight.position.set(5,10,7);
dirLight.castShadow = true;
scene.add(dirLight);

// ——————————————————————
// 3️⃣ Chão
// ——————————————————————
const floorGeo = new THREE.PlaneGeometry(200, 200);
const floorMat = new THREE.MeshStandardMaterial({ color: 0x777777 });
const floor = new THREE.Mesh(floorGeo, floorMat);
floor.rotation.x = -Math.PI / 2;
floor.receiveShadow = true;
scene.add(floor);

// ——————————————————————
// 4️⃣ Blocos de Parkour
// ——————————————————————
function createBlock(x, y, z, w, h, d, color) {
  const geo = new THREE.BoxGeometry(w, h, d);
  const mat = new THREE.MeshStandardMaterial({ color });
  const mesh = new THREE.Mesh(geo, mat);
  mesh.position.set(x, y, z);
  mesh.castShadow = true;
  mesh.receiveShadow = true;
  scene.add(mesh);
  return mesh;
}

// Exemplo de plataformas
createBlock(0, 1, -5, 3, 0.5, 3, 0x00ff00);
createBlock(5, 1.5, -10, 3, 0.5, 3, 0x0000ff);
createBlock(-5, 2, -15, 3, 0.5, 3, 0xff0000);
createBlock(0, 3, -20, 3, 0.5, 3, 0xffff00);

// ——————————————————————
// 5️⃣ Controles e Variáveis de Movimento
// ——————————————————————
const controls = new PointerLockControls(camera, renderer.domElement);
scene.add(controls.getObject());

document.addEventListener('click', () => controls.lock());

const move = { forward: false, back: false, left: false, right: false };
const velocity = new THREE.Vector3();
let canJump = false;

const raycaster = new THREE.Raycaster();
raycaster.ray.direction.set(0, -1, 0);
raycaster.far = 1.6;

const clock = new THREE.Clock();
const speed = 5;

function getMoveDirection() {
  const dir = new THREE.Vector3();
  const forward = new THREE.Vector3();
  const right = new THREE.Vector3();
  controls.getObject().getWorldDirection(forward);
  forward.y = 0; forward.normalize();
  right.crossVectors(forward, new THREE.Vector3(0,1,0)).normalize();

  if (move.forward) dir.add(forward);
  if (move.back) dir.sub(forward);
  if (move.left) dir.sub(right);
  if (move.right) dir.add(right);
  if (dir.length() > 0) dir.normalize();
  return dir;
}

// Teclado
document.addEventListener('keydown', e => {
  if (e.code === 'KeyW') move.forward = true;
  if (e.code === 'KeyS') move.back = true;
  if (e.code === 'KeyA') move.left = true;
  if (e.code === 'KeyD') move.right = true;
  if (e.code === 'Space' && canJump) {
    velocity.y = 5;
    canJump = false;
  }
});
document.addEventListener('keyup', e => {
  if (e.code === 'KeyW') move.forward = false;
  if (e.code === 'KeyS') move.back = false;
  if (e.code === 'KeyA') move.left = false;
  if (e.code === 'KeyD') move.right = false;
});

// ——————————————————————
// 6️⃣ Loop de Animação e Gravidade
// ——————————————————————
function animate() {
  requestAnimationFrame(animate);
  const dt = clock.getDelta();

  velocity.y -= 9.8 * dt;

  velocity.x *= Math.exp(-10 * dt);
  velocity.z *= Math.exp(-10 * dt);

  const dir = getMoveDirection();
  velocity.x += dir.x * speed * dt;
  velocity.z += dir.z * speed * dt;

  const pos = controls.getObject().position;

  pos.x += velocity.x;
  pos.z += velocity.z;

  // Verifica colisão com chão e plataformas
  raycaster.ray.origin.copy(pos);
  const hits = raycaster.intersectObjects(scene.children, true);
  if (hits.length > 0) {
    const dist = hits[0].distance;
    if (dist < 1.6) {
      velocity.y = Math.max(0, velocity.y);
      canJump = true;
      pos.y = hits[0].point.y + 1.6;
    }
  }

  pos.y += velocity.y * dt;

  renderer.render(scene, camera);
}
animate();

// ——————————————————————
// 7️⃣ Redimensionamento
// ——————————————————————
window.addEventListener('resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
</script>
</body>
</html>
