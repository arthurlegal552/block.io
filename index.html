<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snowy Parkour Adventure</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(to bottom, #0c1445, #1a237e);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        #title-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: opacity 1s ease;
        }
        
        #title-screen h1 {
            font-size: 4rem;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
            color: #ffffff;
            animation: glow 3s infinite alternate;
        }
        
        @keyframes glow {
            0% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.3); }
            100% { text-shadow: 0 0 30px rgba(255, 255, 255, 0.6); }
        }
        
        #title-screen p {
            font-size: 1.2rem;
            max-width: 600px;
            margin-bottom: 30px;
            line-height: 1.6;
            color: #e0e0e0;
        }
        
        #start-btn {
            padding: 15px 50px;
            font-size: 1.4rem;
            background: linear-gradient(to right, #222, #444);
            border: 2px solid #ddd;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            margin-top: 20px;
            animation: pulse 2s infinite;
            letter-spacing: 1px;
            font-weight: bold;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 255, 255, 0.2); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(255, 255, 255, 0.4); }
            100% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 255, 255, 0.2); }
        }
        
        #start-btn:hover {
            animation: none;
            transform: scale(1.05);
            background: linear-gradient(to right, #333, #555);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.4);
        }
        
        #ui-overlay {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 50;
            pointer-events: none;
        }
        
        #controls-panel {
            background: rgba(20, 20, 25, 0.85);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(200, 200, 200, 0.3);
            backdrop-filter: blur(5px);
            max-width: 300px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }
        
        #controls-panel h3 {
            color: #ffffff;
            margin-bottom: 15px;
            font-size: 1.4rem;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
            border-bottom: 1px solid #777;
            padding-bottom: 5px;
        }
        
        .key-row {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .key {
            width: 50px;
            height: 50px;
            background: rgba(60, 60, 70, 0.9);
            border: 2px solid rgba(220, 220, 220, 0.5);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            font-weight: bold;
            font-size: 1.2rem;
            color: #fff;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }
        
        .key-disabled {
            opacity: 0.4;
            border-color: rgba(255, 50, 50, 0.5);
        }
        
        .key-label {
            font-size: 1.1rem;
            color: #e0e0e0;
        }
        
        #speed-indicator {
            background: rgba(20, 20, 25, 0.85);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(200, 200, 200, 0.3);
            backdrop-filter: blur(5px);
            height: fit-content;
            text-align: center;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }
        
        #speed-indicator h3 {
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 1.4rem;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
            border-bottom: 1px solid #777;
            padding-bottom: 5px;
        }
        
        #speed-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        #instructions {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 1.2rem;
            background: rgba(20, 20, 25, 0.85);
            padding: 15px;
            border-top: 1px solid rgba(200, 200, 200, 0.3);
            backdrop-filter: blur(5px);
            color: #e0e0e0;
            box-shadow: 0 -5px 10px rgba(0, 0, 0, 0.2);
        }
        
        canvas {
            display: block;
        }
        
        #particle-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(20, 20, 25, 0.85);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid rgba(200, 200, 200, 0.3);
            cursor: pointer;
            z-index: 50;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        #particle-toggle:hover {
            background: rgba(40, 40, 50, 0.9);
        }
        
        #sound-toggle {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(20, 20, 25, 0.85);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid rgba(200, 200, 200, 0.3);
            cursor: pointer;
            z-index: 50;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        #sound-toggle:hover {
            background: rgba(40, 40, 50, 0.9);
        }
        
        .snowflake {
            position: absolute;
            background: white;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.8;
            filter: blur(1px);
        }
        
        #volume-control {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(20, 20, 25, 0.85);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid rgba(200, 200, 200, 0.3);
            z-index: 50;
            backdrop-filter: blur(5px);
            color: #e0e0e0;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        #volume-slider {
            width: 150px;
            margin-top: 5px;
            cursor: pointer;
        }
        
        #stamina-container {
            position: absolute;
            top: 120px;
            right: 20px;
            width: 200px;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 50;
            overflow: hidden;
            display: none;
        }
        
        #stamina-bar {
            height: 100%;
            width: 100%;
            background: linear-gradient(to right, #ffffff, #bbbbbb);
            transition: width 0.2s;
        }
        
        .sprint-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(100,200,255,0.2) 0%, transparent 70%);
            opacity: 0;
            pointer-events: none;
            z-index: 10;
            transition: opacity 0.3s;
        }
        
        /* Exhaustion effect styles */
        #exhaustion-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 0, 0, 0.1) 0%, transparent 70%);
            opacity: 0;
            pointer-events: none;
            z-index: 25;
            transition: opacity 0.5s;
        }
        
        #heartbeat-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            pointer-events: none;
            z-index: 26;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .heartbeat-line {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 0, 0, 0.5) 0%, transparent 70%);
            border-radius: 50%;
            position: absolute;
            transform: scale(0);
        }
        
        .heartbeat-text {
            color: rgba(255, 50, 50, 0.8);
            font-size: 2rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.7);
            animation: textPulse 2s infinite;
        }
        
        @keyframes textPulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        
        #stamina-warning {
            position: absolute;
            top: 150px;
            right: 20px;
            background: rgba(200, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 50;
            display: none;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
        }
        
        #loading-progress {
            width: 300px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        #loading-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #4fc3f7, #00bcd4);
            transition: width 0.3s;
        }
        
        #loading-text {
            margin-top: 10px;
            font-size: 1rem;
        }
        
        .sprint-blocked {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: rgba(255, 50, 50, 0.8);
            font-weight: bold;
            font-size: 1.4rem;
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="loading-screen">
            <h2>LOADING SNOWY PARKOUR...</h2>
            <div id="loading-progress">
                <div id="loading-bar"></div>
            </div>
            <div id="loading-text">Loading assets: 0%</div>
        </div>
        
        <div id="title-screen">
            <h1>❄️ SNOWY PARKOUR ❄️</h1>
            <p>Navigate through a winter wonderland with enhanced movement. Press SHIFT to sprint through the snow!</p>
            <p>Stamina system added - sprint will be blocked when exhausted!</p>
            <button id="start-btn">START JOURNEY</button>
        </div>
        
        <div id="ui-overlay">
            <div id="controls-panel">
                <h3>CONTROLS</h3>
                <div class="key-row">
                    <div class="key">W</div>
                    <div class="key-label">Move Forward</div>
                </div>
                <div class="key-row">
                    <div class="key">A</div>
                    <div class="key-label">Move Left</div>
                </div>
                <div class="key-row">
                    <div class="key">S</div>
                    <div class="key-label">Move Backward</div>
                </div>
                <div class="key-row">
                    <div class="key">D</div>
                    <div class="key-label">Move Right</div>
                </div>
                <div class="key-row">
                    <div class="key">SPACE</div>
                    <div class="key-label">Jump</div>
                </div>
                <div class="key-row">
                    <div class="key" id="sprint-key">SHIFT</div>
                    <div class="key-label">Sprint</div>
                </div>
            </div>
            
            <div id="speed-indicator">
                <h3>MOVEMENT SPEED</h3>
                <div id="speed-value">100%</div>
            </div>
        </div>
        
        <div id="particle-toggle">❄ TOGGLE SNOW</div>
        <div id="sound-toggle">🔊 TOGGLE SOUND</div>
        <div id="stamina-container">
            <div id="stamina-bar"></div>
        </div>
        <div id="stamina-warning">STAMINA DEPLETED! RECOVERING...</div>
        
        <div id="volume-control">
            <div>VOLUME: <span id="volume-value">70%</span></div>
            <input type="range" id="volume-slider" min="0" max="100" value="70">
        </div>
        
        <div id="instructions">
            USE WASD TO MOVE, SPACE TO JUMP, AND SHIFT TO SPRINT!
        </div>
        
        <div class="sprint-effect" id="sprint-effect"></div>
        
        <!-- Exhaustion effects -->
        <div id="exhaustion-overlay"></div>
        <div id="heartbeat-effect">
            <div class="heartbeat-text">EXHAUSTED!</div>
            <div class="heartbeat-line" id="heartbeat-line-1"></div>
            <div class="heartbeat-line" id="heartbeat-line-2"></div>
        </div>
    </div>

    <script>
        // Game state
        let gameStarted = false;
        let particlesEnabled = true;
        let soundEnabled = true;
        let snowflakes = [];
        let collidableObjects = [];
        let stamina = 100;
        let isSprinting = false;
        let sprintCooldown = false;
        let exhausted = false;
        let lastBreathTime = 0;
        let lastSprintSoundTime = 0;
        let sprintSoundCooldown = 0.5;
        let sprintBlocked = false;
        
        // UI Elements
        const titleScreen = document.getElementById('title-screen');
        const startBtn = document.getElementById('start-btn');
        const particleToggle = document.getElementById('particle-toggle');
        const soundToggle = document.getElementById('sound-toggle');
        const instructions = document.getElementById('instructions');
        const speedValue = document.getElementById('speed-value');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeValue = document.getElementById('volume-value');
        const staminaContainer = document.getElementById('stamina-container');
        const staminaBar = document.getElementById('stamina-bar');
        const sprintEffect = document.getElementById('sprint-effect');
        const exhaustionOverlay = document.getElementById('exhaustion-overlay');
        const heartbeatEffect = document.getElementById('heartbeat-effect');
        const staminaWarning = document.getElementById('stamina-warning');
        const loadingScreen = document.getElementById('loading-screen');
        const loadingBar = document.getElementById('loading-bar');
        const loadingText = document.getElementById('loading-text');
        const sprintKey = document.getElementById('sprint-key');
        
        // Sound elements
        let sounds = {};
        let gainNode;
        let audioContext;
        
        // List of local sound files
        const soundFiles = [
            { name: 'ambient', path: 'ambient.mp3' },
            { name: 'footstep', path: 'footstep.mp3' },
            { name: 'jump', path: 'roblox-classic-jump.mp3' },
            { name: 'land', path: 'loud-bone-crack.mp3' },
            { name: 'wind', path: 'asd.mp3' },
            { name: 'sprint', path: 'fnaf-footstep.mp3' },
            { name: 'breath', path: 'dramaticbreathing.mp3' },
            { name: 'heartbeat', path: 'heartbeatloop.mp3' },
            { name: 'blocked', path: 'minecraft-pickaxe-sound.mp3' }
        ];
        
        // Initialize audio context
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                gainNode = audioContext.createGain();
                gainNode.connect(audioContext.destination);
                gainNode.gain.value = volumeSlider.value / 100;
                
                // Load sounds
                loadGameSounds();
            } catch (e) {
                console.error("Audio initialization failed:", e);
                soundEnabled = false;
                soundToggle.innerHTML = "🔇 SOUND DISABLED";
                soundToggle.style.backgroundColor = "#ff4444";
                loadingScreen.style.display = "none";
            }
        }
        
        // Load sounds from local files
        function loadGameSounds() {
            let loadedCount = 0;
            const totalSounds = soundFiles.length;
            
            soundFiles.forEach(sound => {
                sounds[sound.name] = new Audio(sound.path);
                sounds[sound.name].preload = "auto";
                sounds[sound.name].oncanplaythrough = () => {
                    loadedCount++;
                    
                    // Update loading progress
                    const progress = Math.floor((loadedCount / totalSounds) * 100);
                    loadingBar.style.width = `${progress}%`;
                    loadingText.textContent = `Loading assets: ${progress}%`;
                    
                    // Hide loading screen when all sounds are loaded
                    if (loadedCount === totalSounds) {
                        setTimeout(() => {
                            loadingScreen.style.opacity = '0';
                            setTimeout(() => {
                                loadingScreen.style.display = 'none';
                            }, 500);
                        }, 500);
                    }
                };
                sounds[sound.name].onerror = () => {
                    console.error(`Failed to load sound: ${sound.name}`);
                    loadedCount++;
                    loadingBar.style.width = `${Math.floor((loadedCount / totalSounds) * 100)}%`;
                    
                    if (loadedCount === totalSounds) {
                        setTimeout(() => {
                            loadingScreen.style.opacity = '0';
                            setTimeout(() => {
                                loadingScreen.style.display = 'none';
                            }, 500);
                        }, 500);
                    }
                };
            });
        }
        
        // Play a sound
        function playSound(name, volume = 1) {
            if (!soundEnabled || !sounds[name]) return;
            
            try {
                const sound = sounds[name].cloneNode();
                sound.volume = volume * (gainNode.gain.value);
                sound.play().catch(e => console.warn(`Sound play failed: ${e.message}`));
            } catch (e) {
                console.error(`Error playing sound ${name}:`, e);
            }
        }
        
        // Set volume
        volumeSlider.addEventListener('input', () => {
            const volume = volumeSlider.value / 100;
            if (gainNode) gainNode.gain.value = volume;
            volumeValue.textContent = volumeSlider.value + '%';
        });
        
        // Initialize audio when user interacts
        document.addEventListener('click', () => {
            if (!audioContext) {
                initAudio();
            }
        }, { once: true });

        // ——————————————————————
        // 1️⃣ Scene Setup
        // ——————————————————————
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0c1445);
        scene.fog = new THREE.Fog(0x1a237e, 10, 150);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 10);
        
        const renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        document.getElementById('game-container').appendChild(renderer.domElement);
        
        // ——————————————————————
        // 2️⃣ Lighting
        // ——————————————————————
        // Ambient light
        scene.add(new THREE.AmbientLight(0x404040, 1.5));
        
        // Moonlight
        const moonLight = new THREE.DirectionalLight(0x9db4ff, 0.8);
        moonLight.position.set(-10, 20, 10);
        moonLight.castShadow = true;
        moonLight.shadow.mapSize.width = 1024;
        moonLight.shadow.mapSize.height = 1024;
        scene.add(moonLight);
        
        // Fill light
        const fillLight = new THREE.DirectionalLight(0x4d79ff, 0.3);
        fillLight.position.set(10, 10, -10);
        scene.add(fillLight);
        
        // Ground lights
        const groundLight1 = new THREE.PointLight(0x4db8ff, 1, 30);
        groundLight1.position.set(15, 2, -20);
        scene.add(groundLight1);
        
        const groundLight2 = new THREE.PointLight(0xff4da6, 1, 30);
        groundLight2.position.set(-15, 2, -30);
        scene.add(groundLight2);
        
        // ——————————————————————
        // 3️⃣ Snowy Ground
        // ——————————————————————
        const floorGeo = new THREE.PlaneGeometry(200, 200);
        const floorMat = new THREE.MeshStandardMaterial({ 
            color: 0x2c3e50,
            roughness: 0.9,
            metalness: 0.1
        });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);
        collidableObjects.push(floor);
        
        // Snow cover
        const snowGeo = new THREE.PlaneGeometry(200, 200);
        const snowMat = new THREE.MeshStandardMaterial({ 
            color: 0xe0f7fa,
            roughness: 0.8,
            metalness: 0.05,
            transparent: true,
            opacity: 0.8
        });
        const snow = new THREE.Mesh(snowGeo, snowMat);
        snow.rotation.x = -Math.PI / 2;
        snow.position.y = 0.01;
        snow.receiveShadow = true;
        scene.add(snow);
        
        // ——————————————————————
        // 4️⃣ Parkour Blocks with Snow
        // ——————————————————————
        function createBlock(x, y, z, w, h, d, color) {
            // Main block
            const geo = new THREE.BoxGeometry(w, h, d);
            const mat = new THREE.MeshStandardMaterial({ 
                color,
                roughness: 0.7,
                metalness: 0.2
            });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(x, y, z);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            scene.add(mesh);
            
            // Add collider for the main block
            const blockCollider = new THREE.Mesh(
                new THREE.BoxGeometry(w, h, d),
                new THREE.MeshBasicMaterial({ 
                    color: 0xff0000,
                    wireframe: true,
                    visible: false
                })
            );
            blockCollider.position.set(x, y, z);
            scene.add(blockCollider);
            collidableObjects.push(blockCollider);
            
            // Add snow on top
            const snowTopGeo = new THREE.BoxGeometry(w - 0.2, 0.1, d - 0.2);
            const snowTopMat = new THREE.MeshStandardMaterial({ 
                color: 0xffffff,
                roughness: 0.9,
                metalness: 0.05
            });
            const snowTop = new THREE.Mesh(snowTopGeo, snowTopMat);
            snowTop.position.set(x, y + h/2 + 0.05, z);
            snowTop.receiveShadow = true;
            scene.add(snowTop);
            
            // Add collider for snow top
            const snowCollider = new THREE.Mesh(
                new THREE.BoxGeometry(w - 0.2, 0.1, d - 0.2),
                new THREE.MeshBasicMaterial({ 
                    color: 0x00ff00,
                    wireframe: true,
                    visible: false
                })
            );
            snowCollider.position.set(x, y + h/2 + 0.05, z);
            scene.add(snowCollider);
            collidableObjects.push(snowCollider);
            
            return { mesh, snowTop };
        }
        
        // Create parkour course
        createBlock(0, 1, -5, 4, 0.5, 4, 0x3498db);
        createBlock(6, 1.5, -12, 3, 0.5, 3, 0x2ecc71);
        createBlock(-6, 2, -18, 5, 0.5, 2, 0xe74c3c);
        createBlock(0, 3, -25, 3, 0.5, 3, 0xf1c40f);
        createBlock(8, 4, -32, 2, 0.5, 4, 0x9b59b6);
        createBlock(-8, 5, -38, 4, 0.5, 2, 0x1abc9c);
        createBlock(0, 6, -45, 3, 0.5, 10, 0xe67e22);
        
        // Starting platform
        createBlock(0, 0.5, 0, 6, 0.5, 6, 0x34495e);
        
        // Obstacles
        createBlock(4, 1, -15, 1, 2, 1, 0x95a5a6);
        createBlock(-4, 1, -25, 1, 3, 1, 0x95a5a6);
        createBlock(0, 1, -35, 1, 4, 1, 0x95a5a6);
        
        // ——————————————————————
        // 5️⃣ Snow Particle System
        // ——————————————————————
        let particleSystem;
        let particleGeometry;
        let particleMaterial;
        const particleCount = 2500;
        
        function createSnowParticles() {
            particleGeometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            
            for (let i = 0; i < particleCount * 3; i += 3) {
                positions[i] = (Math.random() - 0.5) * 200; // x
                positions[i + 1] = Math.random() * 100;     // y
                positions[i + 2] = (Math.random() - 0.5) * 200; // z
            }
            
            particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            particleMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.15,
                transparent: true,
                opacity: 0.9,
                blending: THREE.AdditiveBlending
            });
            
            particleSystem = new THREE.Points(particleGeometry, particleMaterial);
            scene.add(particleSystem);
        }
        
        function updateSnowParticles(dt) {
            if (!particlesEnabled || !particleSystem) return;
            
            const positions = particleGeometry.attributes.position.array;
            
            for (let i = 0; i < particleCount * 3; i += 3) {
                // Move particles down (snow fall)
                positions[i + 1] -= 1.8 * dt;
                
                // Add slight horizontal movement for wind effect
                positions[i] += (Math.random() - 0.5) * 0.3;
                positions[i + 2] += (Math.random() - 0.5) * 0.3;
                
                // Reset particles that have fallen below ground
                if (positions[i + 1] < 0) {
                    positions[i + 1] = Math.random() * 50 + 50;
                    positions[i] = (Math.random() - 0.5) * 200;
                    positions[i + 2] = (Math.random() - 0.5) * 200;
                }
            }
            
            particleGeometry.attributes.position.needsUpdate = true;
        }
        
        // ——————————————————————
        // 6️⃣ Player Controls with Sprint Functionality
        // ——————————————————————
        const controls = new THREE.PointerLockControls(camera, renderer.domElement);
        scene.add(controls.getObject());
        
        const move = { forward: false, back: false, left: false, right: false };
        const velocity = new THREE.Vector3();
        let canJump = false;
        let lastFootstep = 0;
        
        const clock = new THREE.Clock();
        
        // Movement parameters - increased speed
        const baseSpeed = 3.5; // Increased base speed
        const sprintSpeed = 7.0; // Sprint speed
        let currentSpeed = baseSpeed;
        const jumpForce = 5.0; // Increased jump height
        
        // Player collision box
        const playerCollider = {
            radius: 0.4,
            height: 1.8,
            position: new THREE.Vector3()
        };
        
        function getMoveDirection() {
            const dir = new THREE.Vector3();
            const forward = new THREE.Vector3();
            const right = new THREE.Vector3();
            controls.getObject().getWorldDirection(forward);
            forward.y = 0; forward.normalize();
            right.crossVectors(forward, new THREE.Vector3(0,1,0)).normalize();
        
            if (move.forward) dir.add(forward);
            if (move.back) dir.sub(forward);
            if (move.left) dir.sub(right);
            if (move.right) dir.add(right);
            if (dir.length() > 0) dir.normalize();
            return dir;
        }
        
        // IMPROVED COLLISION DETECTION SYSTEM
        function checkCollisions(pos, dir) {
            // Create capsule collider for player
            const capsule = {
                start: new THREE.Vector3(pos.x, pos.y - playerCollider.height/2 + playerCollider.radius, pos.z),
                end: new THREE.Vector3(pos.x, pos.y + playerCollider.height/2 - playerCollider.radius, pos.z),
                radius: playerCollider.radius
            };
            
            // Create movement vector
            const moveVec = new THREE.Vector3(dir.x, dir.y, dir.z);
            
            // Check against all collidable objects
            for (const object of collidableObjects) {
                if (object.geometry.type === 'BoxGeometry') {
                    const box = new THREE.Box3().setFromObject(object);
                    box.expandByScalar(playerCollider.radius);
                    
                    // Create ray from current to next position
                    const ray = new THREE.Ray(capsule.start, moveVec.clone().normalize());
                    const rayLength = moveVec.length();
                    
                    // Check for intersection
                    const intersection = new THREE.Vector3();
                    const intersect = ray.intersectBox(box, intersection);
                    
                    if (intersect) {
                        // Calculate distance to obstacle
                        const distance = capsule.start.distanceTo(intersection);
                        
                        // If we're closer than our movement distance, collision occurs
                        if (distance < rayLength + playerCollider.radius) {
                            return true;
                        }
                    }
                    
                    // Additional check for top of capsule
                    const rayTop = new THREE.Ray(capsule.end, moveVec.clone().normalize());
                    const intersectTop = rayTop.intersectBox(box, intersection);
                    
                    if (intersectTop) {
                        const distance = capsule.end.distanceTo(intersection);
                        if (distance < rayLength + playerCollider.radius) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }
        
        // Keyboard controls
        document.addEventListener('keydown', e => {
            if (!gameStarted) return;
            
            if (e.code === 'KeyW') move.forward = true;
            if (e.code === 'KeyS') move.back = true;
            if (e.code === 'KeyA') move.left = true;
            if (e.code === 'KeyD') move.right = true;
            if (e.code === 'Space' && canJump) {
                velocity.y = jumpForce;
                canJump = false;
                playSound('jump', 0.7);
            }
            if (e.code === 'ShiftLeft') {
                if (sprintBlocked) {
                    // Play blocked sound if player tries to sprint while exhausted
                    playSound('blocked', 0.6);
                    return;
                }
                
                if (!sprintCooldown && stamina > 0) {
                    // Only start sprinting if not already sprinting
                    if (!isSprinting) {
                        isSprinting = true;
                        staminaContainer.style.display = 'block';
                        sprintEffect.style.opacity = '0.3';
                        
                        // Play sprint sound only once when sprint starts
                        const now = performance.now() / 1000;
                        if (now - lastSprintSoundTime > sprintSoundCooldown) {
                            playSound('sprint', 0.8);
                            lastSprintSoundTime = now;
                        }
                    }
                }
            }
        });
        
        document.addEventListener('keyup', e => {
            if (e.code === 'KeyW') move.forward = false;
            if (e.code === 'KeyS') move.back = false;
            if (e.code === 'KeyA') move.left = false;
            if (e.code === 'KeyD') move.right = false;
            if (e.code === 'ShiftLeft') {
                isSprinting = false;
                sprintEffect.style.opacity = '0';
            }
        });
        
        // ——————————————————————
        // 7️⃣ Game Initialization
        // ——————————————————————
        startBtn.addEventListener('click', () => {
            gameStarted = true;
            titleScreen.style.opacity = '0';
            setTimeout(() => {
                titleScreen.style.display = 'none';
            }, 1000);
            instructions.textContent = 'Click to lock controls. Use WASD to move, SPACE to jump!';
            controls.lock();
            
            // Move camera to player position
            camera.position.set(0, 1.6, 0);
            
            // Play wind sound
            playSound('wind', 0.2);
        });
        
        particleToggle.addEventListener('click', () => {
            particlesEnabled = !particlesEnabled;
            particleToggle.textContent = particlesEnabled ? '❄ DISABLE SNOW' : '❄ ENABLE SNOW';
        });
        
        soundToggle.addEventListener('click', () => {
            soundEnabled = !soundEnabled;
            soundToggle.innerHTML = soundEnabled ? '🔊 DISABLE SOUND' : '🔇 ENABLE SOUND';
        });
        
        // ——————————————————————
        // 8️⃣ Animation Loop with Sprint Block
        // ——————————————————————
        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();
            const time = clock.getElapsedTime();
            
            if (gameStarted) {
                // Apply gravity
                velocity.y -= 9.8 * dt;
        
                // Apply damping for smoother movement
                velocity.x *= Math.exp(-12 * dt);
                velocity.z *= Math.exp(-12 * dt);
                
                // Handle sprinting
                if (isSprinting && stamina > 0) {
                    currentSpeed = sprintSpeed;
                    stamina = Math.max(0, stamina - dt * 25);
                    speedValue.textContent = "200%";
                    speedValue.style.color = "#ffffff";
                    
                    // Disable sprint if stamina runs out
                    if (stamina <= 0) {
                        isSprinting = false;
                        sprintEffect.style.opacity = '0';
                        exhausted = true;
                        sprintBlocked = true; // Block sprint button
                        sprintKey.classList.add('key-disabled');
                        
                        // Show stamina warning
                        staminaWarning.style.display = 'block';
                        playSound('breath', 0.6);
                        setTimeout(() => {
                            staminaWarning.style.display = 'none';
                        }, 3000);
                    }
                } else {
                    currentSpeed = baseSpeed;
                    stamina = Math.min(100, stamina + dt * 15);
                    speedValue.textContent = "100%";
                    speedValue.style.color = "#ffffff";
                    
                    // Unblock sprint when stamina recovers sufficiently
                    if (sprintBlocked && stamina >= 30) {
                        sprintBlocked = false;
                        sprintKey.classList.remove('key-disabled');
                    }
                    
                    // Cooldown if stamina is depleted
                    if (stamina <= 0) {
                        sprintCooldown = true;
                        setTimeout(() => {
                            sprintCooldown = false;
                        }, 2000);
                    }
                }
                
                // Update stamina bar
                staminaBar.style.width = `${stamina}%`;
                
                // Handle exhaustion effects
                if (stamina <= 0) {
                    // Show red exhaustion overlay
                    exhaustionOverlay.style.opacity = '0.6';
                    
                    // Show heartbeat effect
                    heartbeatEffect.style.opacity = '1';
                    
                    // Animate heartbeat lines
                    const heartbeat1 = document.getElementById('heartbeat-line-1');
                    const heartbeat2 = document.getElementById('heartbeat-line-2');
                    
                    heartbeat1.style.animation = 'none';
                    heartbeat2.style.animation = 'none';
                    setTimeout(() => {
                        heartbeat1.style.animation = 'heartbeatPulse 1.2s infinite';
                        heartbeat2.style.animation = 'heartbeatPulse 1.2s infinite 0.4s';
                    }, 10);
                    
                    // Play heartbeat sound occasionally
                    if (time - lastBreathTime > 1.2) {
                        playSound('heartbeat', 0.5);
                        lastBreathTime = time;
                    }
                } else if (stamina < 30) {
                    // Partial exhaustion effect
                    exhaustionOverlay.style.opacity = `${0.3 * (1 - stamina/30)}`;
                    heartbeatEffect.style.opacity = `${0.6 * (1 - stamina/30)}`;
                } else {
                    // Hide exhaustion effects
                    exhaustionOverlay.style.opacity = '0';
                    heartbeatEffect.style.opacity = '0';
                    exhausted = false;
                }
        
                // Get movement direction
                const dir = getMoveDirection();
                
                // Calculate horizontal movement
                const moveX = dir.x * currentSpeed * dt;
                const moveZ = dir.z * currentSpeed * dt;
                
                // Check for collisions before moving
                const newPos = controls.getObject().position.clone();
                newPos.x += moveX;
                newPos.z += moveZ;
                
                // Only apply movement if no collision
                if (!checkCollisions(controls.getObject().position, new THREE.Vector3(moveX, 0, moveZ))) {
                    controls.getObject().position.x += moveX;
                    controls.getObject().position.z += moveZ;
                }
        
                const pos = controls.getObject().position;
        
                // Ground and platform collision
                const raycaster = new THREE.Raycaster();
                raycaster.ray.origin.copy(pos);
                raycaster.ray.direction.set(0, -1, 0);
                raycaster.far = 1.8; // Slightly larger to prevent falling through
                
                const hits = raycaster.intersectObjects(collidableObjects, true);
                if (hits.length > 0) {
                    const dist = hits[0].distance;
                    if (dist < 1.7) {
                        // Play landing sound if we just landed
                        if (velocity.y < -2) {
                            playSound('land', 0.5);
                        }
                        
                        velocity.y = Math.max(0, velocity.y);
                        canJump = true;
                        pos.y = hits[0].point.y + 1.7; // Adjusted to prevent sinking
                        
                        // Footstep sounds
                        const footstepInterval = isSprinting ? 0.3 : 0.5;
                        if ((move.forward || move.back || move.left || move.right) && time - lastFootstep > footstepInterval) {
                            playSound('footstep', isSprinting ? 0.6 : 0.4);
                            lastFootstep = time;
                        }
                    }
                }
        
                pos.y += velocity.y * dt;
                
                // Update snow particles
                updateSnowParticles(dt);
            } else {
                // Intro camera animation
                camera.position.x = Math.sin(time * 0.2) * 10;
                camera.position.z = 10 + Math.cos(time * 0.2) * 10;
                camera.lookAt(0, 0, -20);
            }
        
            renderer.render(scene, camera);
        }
        
        // Initialize snow particles
        createSnowParticles();
        animate();
        
        // ——————————————————————
        // 9️⃣ Window Resizing
        // ——————————————————————
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Add heartbeat animation to styles
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes heartbeatPulse {
                0% { transform: scale(0); opacity: 0.8; }
                50% { transform: scale(1.5); opacity: 0; }
                100% { transform: scale(1.5); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Create some DOM snowflakes for the title screen
        function createTitleSnow() {
            for (let i = 0; i < 100; i++) {
                const snowflake = document.createElement('div');
                snowflake.classList.add('snowflake');
                snowflake.style.width = Math.random() * 5 + 2 + 'px';
                snowflake.style.height = snowflake.style.width;
                snowflake.style.left = Math.random() * 100 + 'vw';
                snowflake.style.top = Math.random() * 100 + 'vh';
                snowflake.style.opacity = Math.random() * 0.5 + 0.3;
                document.getElementById('title-screen').appendChild(snowflake);
                snowflakes.push({
                    el: snowflake,
                    x: parseFloat(snowflake.style.left),
                    y: parseFloat(snowflake.style.top),
                    speed: Math.random() * 0.5 + 0.3,
                    sway: Math.random() * 0.5 - 0.25
                });
            }
        }
        
        function updateTitleSnow() {
            snowflakes.forEach(snowflake => {
                snowflake.y += snowflake.speed;
                snowflake.x += snowflake.sway;
                
                if (snowflake.y > 100) {
                    snowflake.y = -5;
                    snowflake.x = Math.random() * 100;
                }
                
                snowflake.el.style.top = snowflake.y + 'vh';
                snowflake.el.style.left = snowflake.x + 'vw';
            });
            
            requestAnimationFrame(updateTitleSnow);
        }
        
        createTitleSnow();
        updateTitleSnow();
    </script>
</body>
</html>